{{- range $chaincode := .Values.peer.chaincodes }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "hlf-peer.fullname" $ }}-rc-{{ regexReplaceAll "\\W+" ($chaincode.address) "-" }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "hlf-peer.labels" $ | nindent 4 }}
    app.kubernetes.io/component: register-chaincode
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  template:
    metadata:
      labels:
        {{- include "hlf-peer.labels" $ | nindent 8 }}
        app.kubernetes.io/component: register-chaincode
        {{ include "hlf-peer.fullname" $ }}-client: "true"
    spec:
      serviceAccountName: {{ include "hlf-peer.serviceAccountName" $ }}
      restartPolicy: "Never"
      initContainers:
        # load the chaincode id calculator into the peer image prior to peer launch.
        - name: ccid
          image: registry.gitlab.com/xdev-tech/xdev-enterprise-business-network/hlf-k8s/ccid:develop
          imagePullPolicy: IfNotPresent
          command: [sh, -c]
          args: ["cp /ccid /var/hyperledger/fabric/chaincode/ccid/bin"]
          volumeMounts:
            - name: ccid
              mountPath: /var/hyperledger/fabric/chaincode/ccid/bin
      containers:
        - name: main
          image: hyperledger/fabric-tools:{{ $.Values.image.tag }}
          env:
            # as admin
            - name: CORE_PEER_MSPCONFIGPATH
              value: /var/hyperledger/admin_msp
            # peer connection string
            - name: CORE_PEER_ADDRESS
              {{- if $.Values.ingress.enabled }}
              value: {{ $.Values.ingress.host }}:443
              {{- else }}
              value: {{ include "hlf-peer.fullname" $ }}.{{ $.Release.Namespace }}:7051
              {{- end }}
          envFrom:
            - configMapRef:
                name: {{ include "hlf-peer.fullname" $ }}
          command:
            - sh
            - -c
            - |
              set -ex
              ccid=`/var/hyperledger/fabric/chaincode/ccid/bin/ccid {{ $chaincode.address }} {{ $chaincode.label }} -o /tmp/chaincode.tar.gz`
              echo chaincode package id: {{ $chaincode.name }}:$ccid
              while ! peer channel list | grep -qE '^{{ $chaincode.channel }}$'; do
                  echo Waiting for peer to join {{ $chaincode.channel }} channel
                  sleep 3
              done
              if ! peer lifecycle chaincode queryinstalled | grep -q {{ $chaincode.name }}:$ccid; then
                  peer lifecycle chaincode install /tmp/chaincode.tar.gz
              fi
              if ! peer lifecycle chaincode queryapproved --channelID {{ $chaincode.channel }} --name {{ $chaincode.name }}; then
                  peer lifecycle chaincode approveformyorg -o {{ $chaincode.orderer_address }} --channelID {{ $chaincode.channel }} --name {{ $chaincode.name }} --version 1 --package-id {{ $chaincode.name }}:$CCID --sequence 1 --tls --cafile /var/hyperledger/tls/ord/cert/cacert.pem
              fi
          volumeMounts:
            - name: ccid
              mountPath: /var/hyperledger/fabric/chaincode/ccid/bin
            {{- if $.Values.secrets.peer.cert }}
            - mountPath: /var/hyperledger/msp/signcerts
              name: id-cert
            {{- end }}
            {{- if $.Values.secrets.peer.key }}
            - mountPath: /var/hyperledger/msp/keystore
              name: id-key
            {{- end }}
            {{- if $.Values.secrets.peer.caCert }}
            - mountPath: /var/hyperledger/msp/cacerts
              name: cacert
            - mountPath: /var/hyperledger/admin_msp/cacerts
              name: cacert
            {{- end }}
            {{- if $.Values.secrets.peer.intCaCert }}
            - mountPath: /var/hyperledger/msp/intermediatecerts
              name: intcacert
            - mountPath: /var/hyperledger/admin_msp/intermediatecerts
              name: intcacert
            {{- end }}
            {{- if $.Values.secrets.peer.tls }}
            - mountPath: /var/hyperledger/tls/server/pair
              name: tls
            {{- end }}
            {{- if $.Values.secrets.peer.tlsRootCert }}
            - mountPath: /var/hyperledger/tls/server/cert
              name: tls-rootcert
            {{- end }}
            {{- if $.Values.secrets.peer.tlsClient }}
            - mountPath: /var/hyperledger/tls/client/pair
              name: tls-client
            {{- end }}
            {{- if $.Values.secrets.peer.tlsClientRootCert }}
            - mountPath: /var/hyperledger/tls/client/cert
              name: tls-clientrootcert
            {{- end }}
            {{- if $.Values.secrets.ordTlsRootCert }}
            - mountPath: /var/hyperledger/tls/ord/cert
              name: ord-tls-rootcert
            {{- end }}
            {{- if $.Values.secrets.channels }}
              {{- range $channel := $.Values.secrets.channels }}
            - mountPath: /hl_config/channel/{{ $channel.secretName }}
              name: {{ $channel.name }}
              {{- end }}
            {{- end }}
            {{- if $.Values.secrets.adminCert }}
            - mountPath: /var/hyperledger/admin_msp/admincerts
              name: admin-cert
            - mountPath: /var/hyperledger/admin_msp/signcerts
              name: admin-cert
            - mountPath: /var/hyperledger/msp/admincerts
              name: admin-cert
            {{- end }}
            {{- if $.Values.secrets.adminKey }}
            - mountPath: /var/hyperledger/admin_msp/keystore
              name: admin-key
            {{- end }}
            - mountPath: /var/hyperledger/fabric_cfg/core.yaml
              name: builders-config
              subPath: core.yaml
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - name: ccid
          emptyDir: {}
        {{- if $.Values.secrets.peer.cert }}
        - name: id-cert
          secret:
            secretName: {{ $.Values.secrets.peer.cert }}
        {{- end }}
        {{- if $.Values.secrets.peer.key }}
        - name: id-key
          secret:
            secretName: {{ $.Values.secrets.peer.key }}
        {{- end }}
        {{- if $.Values.secrets.peer.caCert }}
        - name: cacert
          secret:
            secretName: {{ $.Values.secrets.peer.caCert }}
        {{- end }}
        {{- if $.Values.secrets.peer.intCaCert }}
        - name: intcacert
          secret:
            secretName: {{ $.Values.secrets.peer.intCaCert }}
        {{- end }}
        {{- if $.Values.secrets.peer.tls }}
        - name: tls
          secret:
            secretName: {{ $.Values.secrets.peer.tls }}
        {{- end }}
        {{- if $.Values.secrets.peer.tlsRootCert }}
        - name: tls-rootcert
          secret:
            secretName: {{ $.Values.secrets.peer.tlsRootCert }}
        {{- end }}
        {{- if $.Values.secrets.peer.tlsClient }}
        - name: tls-client
          secret:
            secretName: {{ $.Values.secrets.peer.tlsClient }}
        {{- end }}
        {{- if $.Values.secrets.peer.tlsClientRootCert }}
        - name: tls-clientrootcert
          secret:
            secretName: {{ $.Values.secrets.peer.tlsClientRootCert }}
        {{- end }}
        {{- if $.Values.secrets.channels }}
          {{- range $channel := $.Values.secrets.channels }}
        - name: {{ $channel.name }}
          secret:
            secretName: {{ $channel.secretName }}
          {{- end }}
        {{- end }}
        {{- if $.Values.secrets.adminCert }}
        - name: admin-cert
          secret:
            secretName: {{ $.Values.secrets.adminCert }}
        {{- end }}
        {{- if $.Values.secrets.adminKey }}
        - name: admin-key
          secret:
            secretName: {{ $.Values.secrets.adminKey }}
        {{- end }}
        {{- if $.Values.secrets.ordTlsRootCert }}
        - name: ord-tls-rootcert
          secret:
            secretName: {{ $.Values.secrets.ordTlsRootCert }}
        {{- end }}
        - name: builders-config
          configMap:
            name: {{ include "hlf-peer.fullname" $ }}-builders-config
            items:
              - key: core.yaml
                path: core.yaml
{{- end }}
